# テスト仕様書

## 1. テスト概要

### 1.1 テストの目的
- システムの品質保証と機能検証
- 設計仕様に対する実装の適合性確認
- 回帰テストによる継続的品質維持
- エラーハンドリングの妥当性検証

### 1.2 テスト方針
- **TDD (Test-Driven Development)** による開発
- **単体テスト** によるモジュール独立性確認
- **統合テスト** によるモジュール間連携確認
- **異常系テスト** による耐障害性確認

### 1.3 テスト環境
- **テストフレームワーク**: Jest 30.0.5
- **言語**: TypeScript 5.9.2
- **実行環境**: Node.js v22.18.0
- **カバレッジ**: Jest内蔵カバレッジ機能
- **モック**: Google Apps Script API

### 1.4 品質指標
- **テスト成功率**: 100% (44/44 テスト通過)
- **コードカバレッジ**: 主要機能90%以上
- **型安全性**: TypeScript厳格モード
- **静的解析**: ESLint警告ゼロ

## 2. テスト対象モジュール

### 2.1 Constants.ts
**役割**: システム定数・設定値の一元管理  
**テストファイル**: `test/unit/Constants.test.ts`  
**テスト数**: 20項目

### 2.2 Logger.ts
**役割**: ログ機能・機密情報マスキング・レベル制御  
**テストファイル**: `test/unit/Logger.test.ts`  
**テスト数**: 24項目

## 3. Constants.ts テスト仕様

### 3.1 基本設定値テスト

#### 3.1.1 SHEETS設定
```typescript
describe('SHEETS', () => {
  test('必要なシート名が定義されている');
});
```
**テスト内容:**
- `import_data`, `import_column`, `config` シート名の定義確認
- 文字列型の値であることを確認

**期待結果:**
- すべてのシート名が適切な文字列で定義されている

#### 3.1.2 COLUMNS設定
```typescript
describe('COLUMNS', () => {
  test('カラム位置が正しく定義されている');
  test('カラム位置の順序が正しい');
});
```
**テスト内容:**
- チェックボックス列(1), 主キー列(2), データ開始列(3)の定義確認
- カラム位置の順序性確認(1 < 2 < 3)

**期待結果:**
- カラム位置が正しい数値で定義され、順序が保たれている

#### 3.1.3 NOTION API設定
```typescript
describe('NOTION', () => {
  test('Notion API設定が正しく定義されている');
  test('レート制限設定が3リクエスト/秒に対応している');
});
```
**テスト内容:**
- API_VERSION, BASE_URL, RATE_LIMIT_DELAY等の定義確認
- レート制限設定の妥当性確認(334ms ≈ 1000ms/3)

**期待結果:**
- Notion API仕様に準拠した設定値
- レート制限対応の適切な間隔設定

### 3.2 エラー管理テスト

#### 3.2.1 エラーコード一意性
```typescript
describe('ERROR_CODES', () => {
  test('すべてのエラーコードが一意である');
  test('エラーコードが適切な形式である');
});
```
**テスト内容:**
- エラーコードの重複チェック
- フォーマット検証(`[A-Z_]+_\d{3}`)

**期待結果:**
- 全エラーコードが一意で、統一フォーマットに準拠

### 3.3 正規表現パターンテスト

#### 3.3.1 DATABASE_ID パターン
```typescript
test('DATABASE_ID パターンが正しく動作する');
```
**テスト内容:**
- 正常なUUID形式の検証
  - `550e8400-e29b-41d4-a716-446655440000` (ハイフン付き)
  - `550e8400e29b41d4a716446655440000` (ハイフン無し)
- 異常な形式の検出
  - `invalid-id`, `550e8400-e29b-41d4-a716` (不完全)

**期待結果:**
- 正常なUUID形式を正しく検出
- 異常な形式を適切に拒否

#### 3.3.2 API_TOKEN パターン
```typescript
test('API_TOKEN パターンが正しく動作する');
```
**テスト内容:**
- 正常なトークン形式: `secret_` + 43文字の英数字
- 異常な形式の検出: プレフィックス無し、文字数不正

**期待結果:**
- Notion APIトークン形式の正確な検証

#### 3.3.3 EMAIL・URL パターン
```typescript
test('EMAIL パターンが正しく動作する');
test('URL パターンが正しく動作する');
```
**テスト内容:**
- メール形式: `user@domain.com`, `user.name+tag@domain.co.jp`
- URL形式: `https://example.com`, `http://localhost:3000/path`
- 異常形式の検出

**期待結果:**
- 一般的なメール・URL形式の適切な検証

### 3.4 メッセージ定義テスト

#### 3.4.1 ユーザーメッセージ
```typescript
describe('MESSAGES', () => {
  test('成功メッセージが定義されている');
  test('エラーメッセージが定義されている');
  test('警告メッセージが定義されている');
});
```
**テスト内容:**
- SUCCESS, ERROR, WARNING各カテゴリのメッセージ存在確認
- 文字列型の確認

**期待結果:**
- 全メッセージカテゴリが適切に定義されている

### 3.5 環境設定テスト

#### 3.5.1 環境別設定
```typescript
describe('ENV_CONFIG', () => {
  test('開発環境設定が定義されている');
  test('本番環境設定が定義されている');
  test('環境別の設定が適切に分かれている');
});
```
**テスト内容:**
- 開発環境: DEBUG、長いタイムアウト、キャッシュ無効
- 本番環境: INFO、標準タイムアウト、キャッシュ有効
- 環境間の設定差分確認

**期待結果:**
- 環境に応じた適切な設定値の分離

## 4. Logger.ts テスト仕様

### 4.1 ログレベル管理テスト

#### 4.1.1 基本ログレベル
```typescript
describe('ログレベル管理', () => {
  test('デフォルトログレベルはINFOである');
  test('ログレベルを変更できる');
  test('環境からログレベルを取得する');
});
```
**テスト内容:**
- デフォルトレベル(INFO)の確認
- setLogLevel()による動的変更
- PropertiesServiceからの環境設定取得

**期待結果:**
- 適切なデフォルト設定とレベル変更機能

#### 4.1.2 ログレベル制御
```typescript
describe('ログレベル制御', () => {
  test('INFOレベル設定時にDEBUGログは出力されない');
  test('ERRORレベル設定時にINFO以下のログは出力されない');
  test('ERRORレベル設定時にERRORログは出力される');
});
```
**テスト内容:**
- レベル階層による出力制御確認
- DEBUG < INFO < WARN < ERROR の階層構造確認

**期待結果:**
- 設定レベル以上のログのみ出力される

### 4.2 ログ出力テスト

#### 4.2.1 各レベルのログ出力
```typescript
describe('ログ出力', () => {
  test('DEBUGログが正しく出力される');
  test('INFOログが正しく出力される');
  test('WARNログが正しく出力される');
  test('ERRORログが正しく出力される');
});
```
**テスト内容:**
- 各レベルでの適切なconsole関数呼び出し確認
- ログメッセージフォーマットの確認
- タイムスタンプ、レベル、コンテキスト情報の確認

**期待結果:**
- 統一されたフォーマットでの適切なログ出力

### 4.3 機密情報マスキングテスト

#### 4.3.1 APIトークンマスキング
```typescript
describe('機密情報のマスキング', () => {
  test('APIトークンがマスキングされる');
});
```
**テスト内容:**
- `apiToken: 'secret_xxx...'` → `secret_a***` への変換確認
- 元データの保護確認

**期待結果:**
- 機密情報が適切にマスキングされ、識別可能な部分のみ表示

#### 4.3.2 ネストしたオブジェクト
```typescript
test('ネストしたオブジェクト内の機密情報もマスキングされる');
```
**テスト内容:**
- 深い階層の機密フィールドのマスキング確認
- `config.token`, `config.password` 等の処理確認

**期待結果:**
- オブジェクト構造に関係なく機密情報を検出・マスキング

#### 4.3.3 配列内マスキング
```typescript
test('配列内の機密情報もマスキングされる');
```
**テスト内容:**
- 配列要素内の機密フィールドのマスキング確認
- 再帰的な処理の確認

**期待結果:**
- 配列内のオブジェクトでも適切なマスキング処理

### 4.4 ログ履歴管理テスト

#### 4.4.1 履歴記録・取得
```typescript
describe('ログ履歴管理', () => {
  test('ログ履歴に正しく記録される');
  test('特定のレベルのログ履歴を取得できる');
  test('ログ履歴をクリアできる');
});
```
**テスト内容:**
- 履歴への適切な記録確認
- レベル別フィルタリング機能確認
- 履歴クリア機能確認

**期待結果:**
- 完全な履歴管理機能の提供

### 4.5 パフォーマンス測定テスト

#### 4.5.1 タイマー機能
```typescript
describe('パフォーマンス測定', () => {
  test('タイマーの開始と終了が正しく動作する');
});
```
**テスト内容:**
- startTimer()、endTimer()の動作確認
- 時間測定の精度確認
- ログ出力フォーマット確認

**期待結果:**
- 正確な実行時間測定とログ出力

### 4.6 異常系テスト

#### 4.6.1 外部依存エラー
```typescript
describe('異常系', () => {
  test('プロパティサービスアクセスエラーでもログは動作する');
  test('サニタイズ処理で循環参照エラーが発生しても動作する');
});
```
**テスト内容:**
- PropertiesService例外時の耐性確認
- 循環参照オブジェクトでの処理確認
- システム全体への影響回避確認

**期待結果:**
- 外部依存エラーでもログシステム自体は継続動作

## 5. モック戦略

### 5.1 Google Apps Script API モック

#### 5.1.1 PropertiesService
```typescript
const mockPropertiesService = {
  getScriptProperties: jest.fn(() => ({
    getProperty: jest.fn(),
    setProperty: jest.fn(),
  })),
};
(global as any).PropertiesService = mockPropertiesService;
```
**モック内容:**
- スクリプトプロパティの取得・設定をモック化
- 各テストケースで異なる戻り値を設定可能

#### 5.1.2 Console
```typescript
const mockConsole = {
  log: jest.fn(),
  info: jest.fn(),
  warn: jest.fn(),
  error: jest.fn(),
};
Object.assign(console, mockConsole);
```
**モック内容:**
- コンソール出力の監視・検証
- 出力内容とフォーマットの確認

### 5.2 モック設定パターン

#### 5.2.1 正常系モック
- 期待される正常な戻り値を設定
- 標準的な処理フローをテスト

#### 5.2.2 異常系モック
- 例外発生、nullの戻り値、タイムアウト等をシミュレート
- エラーハンドリング・耐障害性をテスト

#### 5.2.3 境界値モック
- 最大値、最小値、空文字、特殊文字等
- データバリデーション機能をテスト

## 6. テスト実行・管理

### 6.1 テスト実行コマンド

#### 6.1.1 基本実行
```bash
npm test                    # 全テスト実行
npm test -- --watch        # ウォッチモード
npm test -- --coverage     # カバレッジ付き実行
```

#### 6.1.2 個別実行
```bash
npm test Constants.test.ts  # Constants単体テスト
npm test Logger.test.ts     # Logger単体テスト
```

### 6.2 継続的インテグレーション

#### 6.2.1 品質ゲート
- **テスト成功率**: 100%必須
- **ESLint警告**: ゼロ必須
- **TypeScript型エラー**: ゼロ必須
- **ビルド成功**: 必須

#### 6.2.2 回帰テスト
- 機能追加・修正時の既存テスト実行
- 新規テストケースの追加
- テストカバレッジの維持・向上

## 7. テスト結果

### 7.1 実行結果サマリー
```
Test Suites: 2 passed, 2 total
Tests:       44 passed, 44 total
Snapshots:   0 total
Time:        1.267 s
```

### 7.2 詳細結果

#### 7.2.1 Constants.test.ts
- **総テスト数**: 20
- **成功率**: 100%
- **テスト内容**: 設定値、正規表現、環境設定

#### 7.2.2 Logger.test.ts
- **総テスト数**: 24  
- **成功率**: 100%
- **テスト内容**: ログ機能、マスキング、履歴管理

### 7.3 カバレッジ状況
- **主要機能**: 90%以上カバー
- **エラーハンドリング**: 85%以上カバー
- **異常系パス**: 80%以上カバー

## 8. 今後のテスト拡張

### 8.1 次フェーズの追加テスト

#### 8.1.1 ConfigManager.test.ts
- 設定取得・検証機能
- 認証情報管理
- カラムマッピング処理

#### 8.1.2 Validator.test.ts
- データ形式検証
- 必須項目チェック
- 型変換可能性検証

#### 8.1.3 DataMapper.test.ts
- スプレッドシート → Notion変換
- 各データ型の変換精度
- エラー処理

### 8.2 統合テスト計画

#### 8.2.1 モジュール間連携テスト
- Constants + Logger の連携
- ConfigManager + Validator の連携
- 全モジュール統合テスト

#### 8.2.2 実環境テスト
- Google Apps Script環境での動作確認
- Notion API連携テスト
- スプレッドシート操作テスト

## 9. 品質保証方針

### 9.1 テスト品質基準
- **機能テスト**: 全機能の正常系・異常系をカバー
- **性能テスト**: レスポンス時間・メモリ使用量の確認
- **セキュリティテスト**: 機密情報保護機能の確認
- **ユーザビリティテスト**: エラーメッセージ・UI の適切性

### 9.2 継続的改善
- テストケースの定期見直し
- 新たな不具合パターンの追加
- テストデータの更新・拡充
- テスト実行効率の改善

このテスト仕様書により、実装したコードの品質が体系的に保証され、今後の開発においても一貫した品質基準を維持できます。
