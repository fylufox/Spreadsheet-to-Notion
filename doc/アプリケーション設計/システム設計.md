# システム設計書

## 1. システム概要

### 1.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    Google スプレッドシート                      │
├─────────────────────────────────────────────────────────────┤
│  [import_data]     [import_column]     [config]             │
│  ┌─────────────┐   ┌─────────────┐    ┌─────────────┐       │
│  │☑│主キー│データ│   │列名│Notion名│型│  │設定名│値    │       │
│  │☐│     │田中│   │名前│Name   │T │  │DB_ID│abc...│       │
│  │☐│     │佐藤│   │年齢│Age    │N │  │     │     │       │
│  └─────────────┘   └─────────────┘    └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ onEdit() / onEditInstallable() トリガー
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Google Apps Script                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │TriggerManager│ │ConfigManager │  │   Logger    │          │
│  │ ・onEdit処理 │  │ ・設定読込   │  │ ・ログ出力   │          │
│  │ ・実行制御   │  │ ・認証管理   │  │ ・マスキング │          │
│  │ ・トリガー管理│  │ ・キャッシュ │  │ ・タイマー   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                              │                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ DataMapper  │  │NotionApiClient│ │ Validator   │          │
│  │ ・列マッピング│  │ ・API呼出し │  │ ・データ検証 │          │
│  │ ・型変換     │  │ ・レート制限 │  │ ・形式チェック│          │
│  │ ・検証連携   │  │ ・接続テスト │  │ ・エラー分類 │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS (Notion API v1)
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Notion Database                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   Pages     │  │ Properties  │  │ Relations   │          │
│  │ ・データ行   │  │ ・Title     │  │ ・他DB連携   │          │
│  │ ・メタデータ │  │ ・Text      │  │             │          │
│  │             │  │ ・Number等  │  │             │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 アーキテクチャ概要

**プラットフォーム**: Google Apps Script (V8 Runtime)
**言語**: TypeScript 5.9.2 (ES2020ターゲット)
**ビルドツール**: 
- Rollup 4.46.2 (バンドリング)
- TypeScript Compiler (型チェック)
- clasp 3.0.6 (GASデプロイメント)

**テストフレームワーク**: Jest 30.0.5 (Node.js >= 22)
**外部API**: Notion API v1 (2022-06-28)
**データストレージ**: 
- Google スプレッドシート (メインデータ・設定)
- GAS プロパティサービス (認証情報)
- Notion Database (連携先データ)

**アーキテクチャパターン**: 
- レイヤードアーキテクチャ
- イベント駆動アーキテクチャ (onEdit / onEditInstallable トリガー)
- シングルトンパターン (TriggerManager)
- エラーハンドリング戦略 (カスタムエラークラス)

## 2. モジュール/クラス設計

### 2.1 モジュール/クラス構成

```
src/
├── index.ts                   # エントリーポイント・グローバル関数定義
├── core/
│   ├── TriggerManager.ts      # シングルトン・トリガー管理・メイン制御
│   ├── ConfigManager.ts       # 設定管理・認証情報・キャッシュ機能
│   ├── DataMapper.ts          # データマッピング・変換・検証連携
│   ├── NotionApiClient.ts     # Notion API クライアント・接続管理
│   └── Validator.ts           # データ検証・エラー分類
├── types/
│   └── index.ts               # TypeScript型定義・インターフェース
├── utils/
│   ├── Constants.ts           # 定数定義・エラーコード
│   └── Logger.ts              # 高機能ロガー・マスキング・タイマー
└── test/
    ├── unit/                  # 単体テスト (8ファイル)
    │   ├── TriggerManager.test.ts
    │   ├── ConfigManager.test.ts
    │   ├── DataMapper.test.ts
    │   ├── NotionApiClient.test.ts
    │   ├── Validator.test.ts
    │   ├── Logger.test.ts
    │   └── Constants.test.ts
    └── integration/           # 統合テスト (4ファイル)
        ├── basic-integration.test.ts
        ├── end-to-end-basic.test.ts
        ├── notion-api-basic.test.ts
        └── spreadsheet-basic.test.ts
```

**レイヤー構成:**
- **Entry Layer**: index.ts (エントリーポイント、グローバル関数)
- **Presentation Layer**: TriggerManager (UIイベント処理)
- **Business Logic Layer**: DataMapper, Validator (ビジネスロジック)
- **Data Access Layer**: NotionApiClient, ConfigManager (データアクセス)
- **Infrastructure Layer**: Logger, Constants (インフラストラクチャ)
- **Type Definition Layer**: types/ (型安全性保証)

### 2.2 主要モジュール概要

| モジュール名 | 責務 | 主要メソッド | 設計パターン |
|-------------|------|-------------|-------------|
| TriggerManager | メイン制御・トリガー処理・状態管理 | onEdit(), processImport(), setupInstallableTriggers() | Singleton |
| ConfigManager | 設定・認証管理・キャッシュ | getConfig(), getApiToken(), getColumnMappings() | Static Class |
| DataMapper | データ変換・マッピング・検証連携 | mapRowToNotionPage(), validateMapping() | Static Class |
| NotionApiClient | Notion API通信・接続管理 | createPage(), updatePage(), testConnection() | Instance |
| Validator | データ検証・エラー分類 | validateRowData(), validateColumnMappings() | Static Class |
| Logger | 高機能ログ・マスキング・タイマー | info(), error(), startTimer(), maskSensitiveData() | Static Class |

### 2.3 TypeScript型システム

**主要インターフェース:**
```typescript
// システム設定
interface SystemConfig {
  databaseId: string;
  projectName: string;
  version: string;
  apiToken: string;
  batchSize?: number;
  // ... その他設定
}

// カラムマッピング
interface ColumnMapping {
  spreadsheetColumn: string;
  notionPropertyName: string;
  dataType: string;
  isTarget: boolean;
  isRequired: boolean;
}

// エラー分類
enum ErrorType {
  CONFIG_ERROR = 'CONFIG_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  API_ERROR = 'API_ERROR',
  NETWORK_ERROR = 'NETWORK_ERROR',
  PERMISSION_ERROR = 'PERMISSION_ERROR',
}
```

**カスタムエラークラス:**
```typescript
export class SpreadsheetToNotionError extends Error {
  constructor(
    message: string,
    public readonly type: ErrorType,
    public readonly originalError?: Error
  ) { ... }
}
```

## 3. データ設計

### 3.1 スプレッドシート設計

**import_data シート構造:**
```
| A列(1) | B列(2) | C列(3) | D列(4) | E列(5) | ...
|--------|--------|--------|--------|--------|-----|
| ☑     | PageID | 名前    | 年齢    | 部署    | ... |
| ☐     |        | 田中    | 30     | 開発    | ... |
| ☐     |        | 佐藤    | 25     | 営業    | ... |
```

- A列: チェックボックス (インポートトリガー)
- B列: 主キー情報 (Notion Page ID、更新用)
- C列以降: 実データ (Notionにインポートするデータ)

**import_column シート構造:**
```
| スプレッドシートカラム | Notionプロパティ名 | データ型 | 連携対象 | 必須 |
|---------------------|-------------------|---------|---------|------|
| 名前                | Name              | title   | yes     | yes  |
| 年齢                | Age               | number  | yes     | no   |
| 部署                | Department        | select  | yes     | no   |
| 備考                | Notes             | rich_text| no     | no   |
```

**config シート構造:**
```
| 設定項目        | 値                    | 説明                      |
|----------------|-----------------------|---------------------------|
| DATABASE_ID    | abc123...             | NotionデータベースID       |
| PROJECT_NAME   | プロジェクト名          | 識別用プロジェクト名       |
| VERSION        | 1.0.0                 | システムバージョン         |
| LAST_UPDATE    | 2025-08-11            | 最終更新日                |
```

### 3.2 GAS プロパティサービス

**セキュアな設定項目:**
```typescript
// PropertiesService.getScriptProperties()
{
  "NOTION_API_TOKEN": "secret_xxx...",     // Notion Integration Token
  // 将来拡張用：暗号化キー等
}
```

### 3.3 Notion データベース設計

**対応プロパティタイプ:**
```typescript
type NotionProperty =
  | { type: 'title'; title: Array<{ text: { content: string } }> }
  | { type: 'rich_text'; rich_text: Array<{ text: { content: string } }> }
  | { type: 'number'; number: number | null }
  | { type: 'select'; select: { name: string } | null }
  | { type: 'multi_select'; multi_select: Array<{ name: string }> }
  | { type: 'date'; date: { start: string; end?: string } | null }
  | { type: 'checkbox'; checkbox: boolean }
  | { type: 'url'; url: string | null }
  | { type: 'email'; email: string | null }
  | { type: 'phone_number'; phone_number: string | null };
```

### 3.4 定数・設定管理

**Constants.ts (TypeScript):**
```typescript
export const CONSTANTS = {
  // シート名
  SHEETS: {
    IMPORT_DATA: 'import_data',
    IMPORT_COLUMN: 'import_column', 
    CONFIG: 'config'
  },
  
  // カラム位置
  COLUMNS: {
    CHECKBOX: 1,        // A列: チェックボックス
    PRIMARY_KEY: 2,     // B列: 主キー
    DATA_START: 3       // C列: データ開始
  },
  
  // Notion API設定
  NOTION: {
    API_VERSION: '2022-06-28',
    BASE_URL: 'https://api.notion.com/v1',
    RATE_LIMIT_DELAY: 334  // 3リクエスト/秒制限対応
  },
  
  // データ型マッピング
  DATA_TYPES: {
    TITLE: 'title',
    RICH_TEXT: 'rich_text',
    NUMBER: 'number',
    SELECT: 'select',
    MULTI_SELECT: 'multi_select',
    DATE: 'date',
    CHECKBOX: 'checkbox',
    URL: 'url',
    EMAIL: 'email',
    PHONE_NUMBER: 'phone_number'
  },
  
  // エラーコード
  ERROR_CODES: {
    CONFIG_ERROR: 'CONFIG_001',
    MAPPING_ERROR: 'MAPPING_002', 
    API_ERROR: 'API_003',
    VALIDATION_ERROR: 'VALIDATION_004',
    PERMISSION_ERROR: 'PERMISSION_005'
  },
  
  // デフォルト値
  DEFAULTS: {
    VERSION: '1.0.0',
    BATCH_SIZE: 10,
    RETRY_ATTEMPTS: 3,
    RETRY_DELAY: 1000
  }
};
```

## 4. 処理設計

### 4.1 メイン処理フロー

```mermaid
flowchart TD
    A[チェックボックスクリック] --> B[onEdit / onEditInstallable トリガー発火]
    B --> C[TriggerManager.onEdit()]
    C --> D{重複処理チェック}
    D -->|処理中| E[処理スキップ]
    D -->|空き| F{チェックボックス列？}
    F -->|No| G[処理終了]
    F -->|Yes| H{チェック状態？}
    H -->|未チェック| G
    H -->|チェック済| I[セキュリティ検証]
    I --> J[ConfigManager.getConfig()]
    J --> K{設定取得成功？}
    K -->|No| L[設定エラー通知]
    K -->|Yes| M[行データ取得]
    M --> N[DataMapper.mapRowToNotionPage()]
    N --> O[Validator.validateRowData()]
    O --> P{検証成功？}
    P -->|No| Q[検証エラー通知]
    P -->|Yes| R{主キー存在？}
    R -->|Yes| S[NotionApiClient.updatePage()]
    R -->|No| T[NotionApiClient.createPage()]
    S --> U{API成功？}
    T --> U
    U -->|Yes| V[成功通知・主キー記録]
    U -->|No| W[エラーハンドリング・リトライ判定]
    E --> X[処理完了]
    G --> X
    L --> X
    Q --> X
    V --> X
    W --> X
```

### 4.2 TypeScriptベース実装

#### 4.2.1 TriggerManager（シングルトン）
```typescript
export class TriggerManager {
  private static instance: TriggerManager;
  private processingStatus: ProcessingStatus;

  static getInstance(): TriggerManager {
    if (!TriggerManager.instance) {
      TriggerManager.instance = new TriggerManager();
    }
    return TriggerManager.instance;
  }

  async onEdit(e: EditEvent): Promise<void> {
    // 重複実行防止
    if (this.processingStatus.isProcessing) {
      Logger.warn('Processing already in progress, skipping');
      return;
    }
    
    // チェックボックス列・値の検証
    if (!this.isCheckboxColumn(e.range) || !this.isCheckboxChecked(e.value)) {
      return;
    }
    
    // メイン処理実行
    await this.processImport(e.range.getRow());
  }
}
```

#### 4.2.2 データマッピング処理
```typescript
export class DataMapper {
  static mapRowToNotionPage(
    rowData: any[], 
    mappings: ColumnMapping[]
  ): NotionPageData {
    Logger.startTimer('DataMapper.mapRowToNotionPage');
    
    try {
      // データ検証
      const validationResult = Validator.validateRowData(rowData, mappings);
      if (!validationResult.valid) {
        throw new MappingError(
          `Row ${rowNumber} validation failed: ${validationResult.errors.join(', ')}`
        );
      }

      // マッピング実行
      const properties: Record<string, NotionProperty> = {};
      
      mappings.forEach(mapping => {
        if (!mapping.isTarget) return;
        
        const columnIndex = this.getColumnIndex(mapping.spreadsheetColumn);
        const value = rowData[columnIndex];
        
        properties[mapping.notionPropertyName] = 
          this.convertToNotionProperty(value, mapping.dataType);
      });
      
      return { properties };
    } finally {
      Logger.endTimer('DataMapper.mapRowToNotionPage');
    }
  }
}
```

#### 4.2.3 エラーハンドリング戦略
```typescript
export class TriggerManager {
  private handleError(error: any, context?: any): void {
    // エラー履歴に記録
    this.processingStatus.errorHistory.push({
      timestamp: new Date(),
      error: error instanceof Error ? error.message : String(error),
      context,
    });

    // ログ記録（機密情報マスキング）
    Logger.error('TriggerManager error occurred', { error, context });

    // ユーザー通知メッセージの決定
    let userMessage = 'データの連携中にエラーが発生しました。';
    
    if (error instanceof SpreadsheetToNotionError) {
      switch (error.type) {
        case ErrorType.CONFIG_ERROR:
          userMessage = '設定に問題があります。管理者にお問い合わせください。';
          break;
        case ErrorType.VALIDATION_ERROR:
          userMessage = `データに問題があります: ${error.message}`;
          break;
        case ErrorType.API_ERROR:
          userMessage = 'Notion APIとの通信でエラーが発生しました。';
          break;
        // ... その他のエラータイプ
      }
    }

    this.showErrorMessage(userMessage);
  }
}
```

### 4.3 インストール可能トリガー対応

#### 4.3.1 権限問題の解決
```typescript
export class TriggerManager {
  /**
   * インストール可能なトリガーを設定
   * 外部API権限問題を解決
   */
  static setupInstallableTriggers(): void {
    try {
      // 既存のトリガーをクリア
      TriggerManager.clearAllTriggers();

      // 編集トリガーを設定
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      ScriptApp.newTrigger('onEditInstallable')
        .forSpreadsheet(spreadsheet)
        .onEdit()
        .create();

      Logger.info('Installable triggers setup completed');
    } catch (error) {
      Logger.error('Failed to setup installable triggers', { error });
    }
  }
}

// グローバル関数（GAS用）
globalThis.onEditInstallable = function (e: any): void {
  const triggerManager = TriggerManager.getInstance();
  triggerManager.onEdit(e as EditEvent).catch(error => {
    Logger.error('Unhandled error in onEditInstallable trigger', { error });
  });
};
```

### 4.4 API レート制限対応

```typescript
export class NotionApiClient {
  private rateLimiter = new RateLimiter();

  async makeRequest(endpoint: string, options: RequestOptions = {}): Promise<any> {
    // レート制限対応
    await this.rateLimiter.waitForRateLimit();
    
    const response = await UrlFetchApp.fetch(
      `${this.baseUrl}${endpoint}`,
      {
        ...options,
        headers: this.headers,
        muteHttpExceptions: true
      }
    );

    // エラーハンドリング
    if (response.getResponseCode() >= 400) {
      throw new ApiError(
        'API request failed',
        response.getResponseCode(),
        response.getContentText()
      );
    }

    return JSON.parse(response.getContentText());
  }
}

class RateLimiter {
  private lastRequestTime = 0;
  private readonly minInterval = 334; // 3リクエスト/秒制限

  async waitForRateLimit(): Promise<void> {
    const now = Date.now();
    const timeSinceLastRequest = now - this.lastRequestTime;
    
    if (timeSinceLastRequest < this.minInterval) {
      const waitTime = this.minInterval - timeSinceLastRequest;
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    
    this.lastRequestTime = Date.now();
  }
}
```

## 5. セキュリティ設計

### 5.1 認証情報管理

**階層化されたセキュリティモデル:**

```typescript
// レベル1: 高セキュリティ (GAS プロパティサービス)
export class ConfigManager {
  static setApiToken(token: string): boolean {
    try {
      PropertiesService.getScriptProperties().setProperty(
        CONSTANTS.CONFIG_KEYS.NOTION_API_TOKEN,
        token
      );
      return true;
    } catch (error) {
      Logger.error('Failed to set API token', error);
      return false;
    }
  }

  static getApiToken(): string {
    const token = PropertiesService
      .getScriptProperties()
      .getProperty(CONSTANTS.CONFIG_KEYS.NOTION_API_TOKEN);
    
    if (!token) {
      throw new ConfigError('API Token not configured');
    }
    
    return token;
  }
}

// レベル2: 中セキュリティ (設定シート)
// データベースIDなどの一般設定情報

// レベル3: 低セキュリティ (公開情報)
const PUBLIC_CONFIG = {
  PROJECT_NAME: 'Sample Project',
  VERSION: '1.0.0'
};
```

### 5.2 Logger機能による機密情報保護

```typescript
export class Logger {
  /**
   * 機密情報のマスキング処理
   */
  static maskSensitiveData(data: any): any {
    if (typeof data !== 'object' || data === null) {
      return data;
    }

    const masked = JSON.parse(JSON.stringify(data));
    
    // APIトークンのマスキング
    if (masked.apiToken) {
      masked.apiToken = this.maskToken(masked.apiToken);
    }
    if (masked.token) {
      masked.token = this.maskToken(masked.token);
    }
    
    // 設定の再帰的処理
    Object.keys(masked).forEach(key => {
      if (typeof masked[key] === 'object') {
        masked[key] = this.maskSensitiveData(masked[key]);
      }
    });
    
    return masked;
  }

  private static maskToken(token: string): string {
    if (!token || token.length < 8) return '***';
    return token.substring(0, 8) + '***';
  }
}
```

### 5.3 外部API セキュリティ

**Notion API 権限設定:**
```json
{
  "integration_type": "internal",
  "capabilities": {
    "read_content": false,       // コンテンツ読み取り不要
    "update_content": true,      // ページ更新必要
    "insert_content": true       // ページ作成必要
  },
  "content_capabilities": {
    "read_user_info": false,     // ユーザー情報不要
    "read_database": true,       // DB情報取得必要
    "update_database": false     // DB構造変更不要
  }
}
```

**API通信セキュリティ:**
```typescript
export class NotionApiClient {
  private headers: Record<string, string>;

  constructor() {
    this.headers = {
      'Authorization': `Bearer ${ConfigManager.getApiToken()}`,
      'Notion-Version': CONSTANTS.NOTION.API_VERSION,
      'Content-Type': 'application/json'
    };
  }
  
  async makeRequest(endpoint: string, options: RequestOptions = {}): Promise<any> {
    // HTTPSで通信、認証ヘッダー自動付与
    const response = await UrlFetchApp.fetch(
      `${CONSTANTS.NOTION.BASE_URL}${endpoint}`,
      {
        ...options,
        headers: this.headers,
        muteHttpExceptions: true  // エラー情報の詳細取得
      }
    );
    
    // レスポンス検証
    if (!response || response.getResponseCode() >= 400) {
      throw new ApiError(
        'API request failed',
        response.getResponseCode(),
        response.getContentText()
      );
    }
    
    return JSON.parse(response.getContentText());
  }
}
```

### 5.4 アクセス制御

**スプレッドシートアクセス制御:**
```typescript
export class TriggerManager {
  private validateAccess(e: EditEvent): void {
    try {
      // スプレッドシートの編集権限があることは既に確認済み
      // 追加のセキュリティチェックが必要な場合はここで実装
      Logger.debug('Access validation passed', { user: e.user.getEmail() });
    } catch (error) {
      throw new SpreadsheetToNotionError(
        'アクセス権限の確認に失敗しました',
        ErrorType.PERMISSION_ERROR,
        error as Error
      );
    }
  }
}

// 設定シート構造の検証
export class ConfigManager {
  static validateSheetStructure(): void {
    const sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
    const requiredSheets = [
      CONSTANTS.SHEETS.IMPORT_DATA,
      CONSTANTS.SHEETS.IMPORT_COLUMN,
      CONSTANTS.SHEETS.CONFIG
    ];
    
    for (const requiredSheet of requiredSheets) {
      if (!sheets.find(sheet => sheet.getName() === requiredSheet)) {
        throw new ConfigError(`Required sheet '${requiredSheet}' not found`);
      }
    }
  }
}
```

## 6. 運用・保守設計

### 6.1 デバッグ・診断機能

**豊富なデバッグ関数（index.ts）:**
```typescript
// システム診断
globalThis.runDiagnostics = runDiagnostics;
globalThis.testConfiguration = testConfiguration;
globalThis.diagnoseProperties = diagnoseProperties;
globalThis.diagnoseColumnMappingSheet = diagnoseColumnMappingSheet;

// トリガー管理
globalThis.setupTriggers = setupTriggers;
globalThis.clearTriggers = clearTriggers;
globalThis.showTriggerStatus = showTriggerStatus;

// 手動テスト
globalThis.testOnEditManually = testOnEditManually;
globalThis.testTriggerManager = testTriggerManager;
```

### 6.2 ログ・モニタリング

**高機能ログシステム:**
```typescript
export class Logger {
  // タイマー機能
  static startTimer(operation: string): void;
  static endTimer(operation: string): void;
  
  // 構造化ログ
  static info(message: string, data?: any): void;
  static error(message: string, error?: any): void;
  
  // 機密情報マスキング
  static maskSensitiveData(data: any): any;
}
```

### 6.3 テスト戦略

**包括的テストスイート:**
- **単体テスト**: 8ファイル (Jest)
- **統合テスト**: 4ファイル
- **カバレッジ**: 178テスト全合格
- **継続的インテグレーション**: npm run test

### 6.4 設定管理

**環境別デプロイメント:**
```json
{
  "scripts": {
    "deploy": "npm run lint && npm run test && npm run build && npx ncp .clasp-dev.json .clasp.json && clasp push -f",
    "deploy:prod": "npm run lint && npm run test && npm run build && npx ncp .clasp-prod.json .clasp.json && clasp push"
  }
}
```

## 7. パフォーマンス設計

### 7.1 設定キャッシュ戦略

```typescript
export class ConfigManager {
  private static configCache: SystemConfig | null = null;
  private static cacheTimestamp = 0;
  private static readonly CACHE_DURATION = 5 * 60 * 1000; // 5分

  static async getConfig(): Promise<SystemConfig> {
    const now = Date.now();
    
    // キャッシュの有効性チェック
    if (this.configCache && (now - this.cacheTimestamp) < this.CACHE_DURATION) {
      Logger.endTimer('ConfigManager.getConfig (cached)');
      return this.configCache;
    }

    // 新規読み込み
    Logger.startTimer('ConfigManager.getConfig');
    // ... 設定読み込み処理
    this.configCache = config;
    this.cacheTimestamp = now;
    
    return config;
  }
}
```

### 7.2 エラー履歴管理

```typescript
export class TriggerManager {
  private handleError(error: any, context?: any): void {
    // エラー履歴の制限（最新100件まで）
    if (this.processingStatus.errorHistory.length > 100) {
      this.processingStatus.errorHistory.shift();
    }
    
    this.processingStatus.errorHistory.push({
      timestamp: new Date(),
      error: error instanceof Error ? error.message : String(error),
      context,
    });
  }
}
```
