# システム設計書

## 1. システム概要

### 1.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    Google スプレッドシート                      │
├─────────────────────────────────────────────────────────────┤
│  [import_data]     [import_column]     [config]             │
│  ┌─────────────┐   ┌─────────────┐    ┌─────────────┐       │
│  │☑│主キー│データ│   │列名│Notion名│型│  │設定名│値    │       │
│  │☐│     │田中│   │名前│Name   │T │  │DB_ID│abc...│       │
│  │☐│     │佐藤│   │年齢│Age    │N │  │     │     │       │
│  └─────────────┘   └─────────────┘    └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ onEdit() トリガー
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Google Apps Script                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ TriggerMgr  │  │ ConfigMgr   │  │ ErrorMgr    │          │
│  │ ・onEdit    │  │ ・設定読込   │  │ ・エラー通知 │          │
│  │ ・実行制御   │  │ ・認証管理   │  │ ・ログ出力   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                              │                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ DataMapper  │  │ NotionAPI   │  │ Validator   │          │
│  │ ・列マッピング│  │ ・API呼出し │  │ ・データ検証 │          │
│  │ ・型変換     │  │ ・レート制限 │  │ ・形式チェック│          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS (Notion API)
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Notion Database                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   Pages     │  │ Properties  │  │ Relations   │          │
│  │ ・データ行   │  │ ・Title     │  │ ・他DB連携   │          │
│  │ ・メタデータ │  │ ・Text      │  │             │          │
│  │             │  │ ・Number等  │  │             │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 アーキテクチャ概要

**プラットフォーム**: Google Apps Script (V8 Runtime)
**言語**: JavaScript (ES6+)
**ビルドツール**: clasp (Command Line Apps Script Projects)
**外部API**: Notion API v1
**データストレージ**: 
- Google スプレッドシート (メインデータ・設定)
- GAS プロパティサービス (認証情報)
- Notion Database (連携先データ)

**アーキテクチャパターン**: 
- レイヤードアーキテクチャ
- イベント駆動アーキテクチャ (onEdit トリガー)
- リポジトリパターン (データアクセス層)

## 2. モジュール/クラス設計

### 2.1 モジュール/クラス構成

```
src/
├── main/
│   ├── TriggerManager.js      # トリガー管理・メイン制御
│   ├── ConfigManager.js       # 設定・認証情報管理
│   ├── DataMapper.js          # データマッピング・変換
│   ├── NotionApiClient.js     # Notion API クライアント
│   ├── Validator.js           # データ検証
│   └── ErrorManager.js        # エラーハンドリング・ログ
├── models/
│   ├── SpreadsheetData.js     # スプレッドシートデータモデル
│   ├── NotionPage.js          # Notionページデータモデル
│   └── ColumnMapping.js       # カラムマッピングモデル
├── utils/
│   ├── Constants.js           # 定数定義
│   ├── Logger.js              # ロガー
│   └── DateUtils.js           # 日付ユーティリティ
└── tests/
    ├── TriggerManager.test.js
    ├── DataMapper.test.js
    └── NotionApiClient.test.js
```

**レイヤー構成:**
- **Presentation Layer**: TriggerManager (UIイベント処理)
- **Business Logic Layer**: DataMapper, Validator (ビジネスロジック)
- **Data Access Layer**: NotionApiClient, ConfigManager (データアクセス)
- **Cross-cutting**: ErrorManager, Logger (横断的関心事)

### 2.2 主要モジュール概要

| モジュール名 | 責務 | 主要メソッド |
|-------------|------|-------------|
| TriggerManager | メイン制御・トリガー処理 | onEdit(), processImport() |
| ConfigManager | 設定・認証管理 | getConfig(), getApiToken() |
| DataMapper | データ変換・マッピング | mapToNotionFormat(), validateMapping() |
| NotionApiClient | Notion API通信 | createPage(), updatePage(), getDatabaseInfo() |
| Validator | データ検証 | validateRowData(), validateMapping() |
| ErrorManager | エラー処理・通知 | handleError(), showErrorDialog() |

## 3. データ設計

### 3.1 スプレッドシート設計

**import_data シート構造:**
```
| A列(1) | B列(2) | C列(3) | D列(4) | E列(5) | ...
|--------|--------|--------|--------|--------|-----|
| ☑     | PageID | 名前    | 年齢    | 部署    | ... |
| ☐     |        | 田中    | 30     | 開発    | ... |
| ☐     |        | 佐藤    | 25     | 営業    | ... |
```

- A列: チェックボックス (インポートトリガー)
- B列: 主キー情報 (Notion Page ID、更新用)
- C列以降: 実データ (Notionにインポートするデータ)

**import_column シート構造:**
```
| スプレッドシートカラム | Notionプロパティ名 | データ型 | 連携対象 | 必須 |
|---------------------|-------------------|---------|---------|------|
| 名前                | Name              | title   | Yes     | Yes  |
| 年齢                | Age               | number  | Yes     | No   |
| 部署                | Department        | select  | Yes     | No   |
| 備考                | Notes             | text    | No      | No   |
```

**config シート構造:**
```
| 設定項目        | 値                    | 説明                      |
|----------------|-----------------------|---------------------------|
| DATABASE_ID    | abc123...             | NotionデータベースID       |
| PROJECT_NAME   | プロジェクト名          | 識別用プロジェクト名       |
| VERSION        | 1.0.0                 | システムバージョン         |
| LAST_UPDATE    | 2025-08-10            | 最終更新日                |
```

### 3.2 GAS プロパティサービス

**セキュアな設定項目:**
```javascript
// PropertiesService.getScriptProperties()
{
  "NOTION_API_TOKEN": "secret_xxx...",     // Notion Integration Token
  "ENCRYPTION_KEY": "random_key_xxx...",   // 暗号化キー（将来拡張用）
}
```

### 3.3 Notion データベース設計

**対応プロパティタイプ:**
```typescript
interface NotionPropertyTypes {
  title: string;          // タイトル (必須、1つのみ)
  rich_text: string;      // リッチテキスト
  number: number;         // 数値
  select: {               // セレクト
    name: string;
    color?: string;
  };
  multi_select: Array<{   // マルチセレクト
    name: string;
    color?: string;
  }>;
  date: {                // 日付
    start: string;        // ISO 8601形式
    end?: string;
  };
  checkbox: boolean;      // チェックボックス
  url: string;           // URL
  email: string;         // メール
  phone_number: string;  // 電話番号
  files: Array<{         // ファイル (読み取り専用)
    name: string;
    url: string;
  }>;
}
```

### 3.4 環境変数・定数

**Constants.js:**
```javascript
const CONSTANTS = {
  // シート名
  SHEETS: {
    IMPORT_DATA: 'import_data',
    IMPORT_COLUMN: 'import_column', 
    CONFIG: 'config'
  },
  
  // カラム位置
  COLUMNS: {
    CHECKBOX: 1,        // A列: チェックボックス
    PRIMARY_KEY: 2,     // B列: 主キー
    DATA_START: 3       // C列: データ開始
  },
  
  // Notion API
  NOTION: {
    API_VERSION: '2022-06-28',
    BASE_URL: 'https://api.notion.com/v1',
    RATE_LIMIT_DELAY: 334  // 3リクエスト/秒制限対応
  },
  
  // エラーコード
  ERROR_CODES: {
    CONFIG_ERROR: 'CONFIG_001',
    MAPPING_ERROR: 'MAPPING_002', 
    API_ERROR: 'API_003',
    VALIDATION_ERROR: 'VALIDATION_004'
  }
};
```

## 4. 処理設計

### 4.1 メイン処理フロー

```mermaid
flowchart TD
    A[チェックボックスクリック] --> B[onEdit トリガー発火]
    B --> C[TriggerManager.onEdit()]
    C --> D{チェックボックス列？}
    D -->|No| E[処理終了]
    D -->|Yes| F[ConfigManager.getConfig()]
    F --> G{設定取得成功？}
    G -->|No| H[設定エラー通知]
    G -->|Yes| I[行データ取得]
    I --> J[DataMapper.mapToNotionFormat()]
    J --> K[Validator.validateRowData()]
    K --> L{検証成功？}
    L -->|No| M[検証エラー通知]
    L -->|Yes| N{主キー存在？}
    N -->|Yes| O[NotionApiClient.updatePage()]
    N -->|No| P[NotionApiClient.createPage()]
    O --> Q{API成功？}
    P --> Q
    Q -->|Yes| R[成功通知・主キー記録]
    Q -->|No| S[ErrorManager.handleError()]
    H --> T[処理完了]
    M --> T
    R --> T
    S --> T
    E --> T
```

### 4.2 データマッピング処理

```javascript
/**
 * スプレッドシートデータをNotion形式に変換
 */
function mapToNotionFormat(rowData, columnMappings) {
  const notionProperties = {};
  
  columnMappings.forEach(mapping => {
    if (!mapping.isTarget) return;
    
    const value = rowData[mapping.spreadsheetColumn];
    const notionProperty = convertToNotionProperty(
      value, 
      mapping.notionPropertyType
    );
    
    notionProperties[mapping.notionPropertyName] = notionProperty;
  });
  
  return {
    properties: notionProperties
  };
}
```

### 4.3 エラーハンドリング処理

```javascript
/**
 * エラー処理のフロー
 */
function handleError(error, context) {
  // 1. エラー分類
  const errorType = classifyError(error);
  
  // 2. ログ記録
  Logger.error(`${errorType}: ${error.message}`, context);
  
  // 3. ユーザー通知
  const userMessage = generateUserMessage(errorType, error);
  showErrorDialog(userMessage);
  
  // 4. リトライ可能かチェック
  if (isRetryableError(errorType)) {
    return { shouldRetry: true, delay: calculateDelay(error) };
  }
  
  return { shouldRetry: false };
}
```

### 4.4 API レート制限対応

```javascript
/**
 * レート制限対応の処理
 */
class RateLimiter {
  constructor() {
    this.lastRequestTime = 0;
    this.minInterval = 334; // 3リクエスト/秒制限
  }
  
  async waitForRateLimit() {
    const now = Date.now();
    const timeSinceLastRequest = now - this.lastRequestTime;
    
    if (timeSinceLastRequest < this.minInterval) {
      const waitTime = this.minInterval - timeSinceLastRequest;
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    
    this.lastRequestTime = Date.now();
  }
}
```

### 4.5 バッチ処理設計

```javascript
/**
 * 複数行の一括処理
 */
async function processBatchImport(checkedRows) {
  const results = {
    success: [],
    failed: [],
    total: checkedRows.length
  };
  
  for (const row of checkedRows) {
    try {
      // レート制限対応
      await rateLimiter.waitForRateLimit();
      
      // 個別処理
      const result = await processRowImport(row);
      results.success.push(result);
      
    } catch (error) {
      results.failed.push({
        row: row,
        error: error.message
      });
      
      // 継続可能なエラーは処理継続
      if (!isCriticalError(error)) {
        continue;
      } else {
        break; // 致命的エラーは処理停止
      }
    }
  }
  
  // 結果通知
  showBatchResult(results);
}
```

## 5 セキュリティ

### 5.1 認証情報管理

**階層化されたセキュリティモデル:**

```javascript
// レベル1: 高セキュリティ (GAS プロパティサービス)
PropertiesService.getScriptProperties().setProperties({
  'NOTION_API_TOKEN': 'secret_xxx...'  // 暗号化して保存
});

// レベル2: 中セキュリティ (設定シート)
configSheet.getRange('B1').setValue('database_id_xxx...'); // 平文保存

// レベル3: 低セキュリティ (公開情報)
const PUBLIC_CONFIG = {
  PROJECT_NAME: 'Sample Project',
  VERSION: '1.0.0'
};
```

**認証情報アクセス制御:**
```javascript
class ConfigManager {
  static getApiToken() {
    try {
      const token = PropertiesService
        .getScriptProperties()
        .getProperty('NOTION_API_TOKEN');
      
      if (!token) {
        throw new Error('API Token not configured');
      }
      
      return token;
    } catch (error) {
      Logger.error('Failed to retrieve API token', error);
      throw new Error('Authentication configuration error');
    }
  }
}
```

### 5.2 外部API セキュリティ

**Notion API 権限設定:**
```json
{
  "integration_type": "internal",
  "capabilities": {
    "read_content": false,       // コンテンツ読み取り不要
    "update_content": true,      // ページ更新必要
    "insert_content": true       // ページ作成必要
  },
  "content_capabilities": {
    "read_user_info": false,     // ユーザー情報不要
    "read_database": true,       // DB情報取得必要
    "update_database": false     // DB構造変更不要
  }
}
```

**API通信セキュリティ:**
```javascript
class NotionApiClient {
  constructor() {
    this.baseUrl = 'https://api.notion.com/v1';
    this.headers = {
      'Authorization': `Bearer ${ConfigManager.getApiToken()}`,
      'Notion-Version': '2022-06-28',
      'Content-Type': 'application/json'
    };
  }
  
  async makeRequest(endpoint, options = {}) {
    // HTTPSで通信、認証ヘッダー自動付与
    const response = await UrlFetchApp.fetch(
      `${this.baseUrl}${endpoint}`,
      {
        ...options,
        headers: this.headers,
        muteHttpExceptions: true  // エラー情報の詳細取得
      }
    );
    
    // レスポンス検証
    if (!response || response.getResponseCode() >= 400) {
      throw new ApiError('API request failed', response);
    }
    
    return JSON.parse(response.getContentText());
  }
}
```

### 5.3 データ保護

**機密データのマスキング:**
```javascript
class Logger {
  static info(message, data = {}) {
    // ログ出力時にAPIトークンをマスク
    const sanitizedData = this.sanitizeLogData(data);
    console.log(`[INFO] ${message}`, sanitizedData);
  }
  
  static sanitizeLogData(data) {
    const sanitized = JSON.parse(JSON.stringify(data));
    
    // APIトークンのマスキング
    if (sanitized.token) {
      sanitized.token = sanitized.token.substring(0, 8) + '***';
    }
    
    // その他の機密情報もマスク
    return sanitized;
  }
}
```

### 5.4 アクセス制御

**スプレッドシートアクセス制御:**
```javascript
class SecurityManager {
  static validateAccess() {
    const currentUser = Session.getActiveUser().getEmail();
    const owner = SpreadsheetApp.getActiveSpreadsheet().getOwner().getEmail();
    
    if (currentUser !== owner) {
      throw new Error('Unauthorized access: Only owner can execute imports');
    }
  }
  
  static validateSheetStructure() {
    const sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
    const requiredSheets = ['import_data', 'import_column', 'config'];
    
    for (const requiredSheet of requiredSheets) {
      if (!sheets.find(sheet => sheet.getName() === requiredSheet)) {
        throw new Error(`Required sheet '${requiredSheet}' not found`);
      }
    }
  }
}
