# モジュール・クラス詳細設計

本システムは TypeScript ベースのモジュール構成で、型安全性と保守性を重視した設計となっています。各モジュールの詳細設計は個別ファイルに記載しています。

## モジュール構成

### 📁 **src/core/** - コアビジネスロジック

#### 1. [TriggerManager](./詳細設計/TriggerManager詳細設計.md) 🔧
- **役割**: シングルトン設計によるトリガー管理・メイン制御フロー
- **設計パターン**: Singleton Pattern
- **主要機能**: 
  - onEdit / onEditInstallable トリガー処理
  - データインポート制御・状態管理
  - インストール可能トリガー管理
  - エラーハンドリング・リトライ機能

#### 2. [ConfigManager](./詳細設計/ConfigManager詳細設計.md) ⚙️
- **役割**: 静的クラス設計による設定・認証情報管理
- **設計パターン**: Static Class with Caching
- **主要機能**:
  - スプレッドシート設定読み込み・キャッシュ
  - セキュアなAPI認証情報管理
  - カラムマッピング設定・検証
  - ヘルスチェック・診断機能

#### 3. [DataMapper](./詳細設計/DataMapper詳細設計.md) 🔄
- **役割**: データ変換・マッピング・検証連携
- **設計パターン**: Static Class with Validation
- **主要機能**:
  - TypeScript型安全なデータ変換
  - Notion API形式へのマッピング
  - Validator連携による検証
  - パフォーマンス最適化

#### 4. [NotionApiClient](./詳細設計/NotionApiClient詳細設計.md) 🌐
- **役割**: Notion API通信・接続管理
- **設計パターン**: Instance Class with Rate Limiting
- **主要機能**:
  - ページ作成・更新・取得
  - レート制限対応（3req/s）
  - 接続テスト・ヘルスチェック
  - 詳細なAPI エラーハンドリング

#### 5. [Validator](./詳細設計/Validator詳細設計.md) ✅
- **役割**: TypeScript型ベースのデータ検証
- **設計パターン**: Static Class with Type Guards
- **主要機能**:
  - 行データ形式チェック
  - カラムマッピング整合性チェック
  - Notionプロパティ互換性検証
  - 詳細なエラー分類・報告

### 📁 **src/utils/** - ユーティリティ・インフラ

#### 6. **Logger** 📝
- **役割**: 高機能ログ・マスキング・タイマー機能
- **設計パターン**: Static Class with Sensitive Data Protection
- **主要機能**:
  - 構造化ログ出力（DEBUG/INFO/WARN/ERROR）
  - 機密情報の自動マスキング
  - パフォーマンス計測タイマー
  - コンソール・ファイル出力対応

#### 7. **Constants** 🏛️
- **役割**: システム全体の定数・設定値管理
- **主要機能**:
  - シート名・カラム位置定数
  - Notion API設定値
  - データ型マッピング定義
  - エラーコード体系

### 📁 **src/types/** - 型定義

#### 8. **型定義システム** 📋
- **役割**: TypeScript型安全性保証
- **主要要素**:
  - インターフェース定義（SystemConfig, ColumnMapping等）
  - カスタムエラークラス体系
  - Notion APIレスポンス型
  - 列挙型（ErrorType, LogLevel等）

### 📁 **src/** - エントリーポイント

#### 9. **index.ts** 🚪
- **役割**: Google Apps Script用エントリーポイント
- **主要機能**:
  - グローバル関数定義
  - デバッグ・診断関数群
  - トリガー管理関数
  - 手動テスト機能

## アーキテクチャ関係図

```
📁 src/index.ts (Entry Point)
         │
┌─────────────────┐
│  TriggerManager │ ← シングルトン・制御フロー・状態管理
│   (Singleton)   │
└─────────────────┘
         │
         ├─→ ┌─────────────────┐
         │   │  ConfigManager  │ ← 静的クラス・設定管理・キャッシュ
         │   │  (Static+Cache) │
         │   └─────────────────┘
         │
         ├─→ ┌─────────────────┐
         │   │   DataMapper    │ ← 静的クラス・データ変換・検証連携
         │   │    (Static)     │
         │   └─────────────────┘
         │            │
         │            ▼
         ├─→ ┌─────────────────┐
         │   │    Validator    │ ← 静的クラス・型ガード・検証
         │   │    (Static)     │
         │   └─────────────────┘
         │
         ├─→ ┌─────────────────┐
         │   │ NotionApiClient │ ← インスタンス・API通信・レート制限
         │   │   (Instance)    │
         │   └─────────────────┘
         │
         └─→ ┌─────────────────┐
             │     Logger      │ ← 静的クラス・ログ・マスキング・タイマー
             │  (Static+Utils) │ ← （全モジュールから利用）
             └─────────────────┘
                      │
                      ▼
             ┌─────────────────┐
             │   Constants     │ ← 定数・設定値・型定義
             │   (Static)      │
             └─────────────────┘
```

## 設計パターン適用状況

| モジュール | デザインパターン | 理由・利点 |
|-----------|----------------|-----------|
| TriggerManager | Singleton | GAS環境での状態管理・重複実行防止 |
| ConfigManager | Static Class + Caching | 設定の一元管理・パフォーマンス向上 |
| DataMapper | Static Class | ステートレスな変換処理・テスト容易性 |
| Validator | Static Class + Type Guards | 型安全性・純粋関数的設計 |
| NotionApiClient | Instance Class | API状態管理・レート制限制御 |
| Logger | Static Class + Strategy | 横断的関心事・プラガブル出力 |

## 共通データ構造

### システム全体で使用される TypeScript インターフェース

```typescript
// 📋 システム設定
interface SystemConfig {
  databaseId: string;
  projectName: string;
  version: string;
  apiToken: string;
  batchSize?: number;
  autoSyncEnabled?: boolean;
  retryAttempts?: number;
  retryDelay?: number;
  webhookUrl?: string;
}

// 📋 カラムマッピング
interface ColumnMapping {
  spreadsheetColumn: string;
  notionPropertyName: string;
  dataType: string;
  isTarget: boolean;
  isRequired: boolean;
}

// 📋 Notionページデータ
interface NotionPageData {
  properties: Record<string, NotionProperty>;
  children?: any[]; // ページ内のブロック要素（オプション）
}

// 📋 型安全なNotionプロパティ
type NotionProperty =
  | { type: 'title'; title: Array<{ text: { content: string } }> }
  | { type: 'rich_text'; rich_text: Array<{ text: { content: string } }> }
  | { type: 'number'; number: number | null }
  | { type: 'select'; select: { name: string } | null }
  | { type: 'multi_select'; multi_select: Array<{ name: string }> }
  | { type: 'date'; date: { start: string; end?: string } | null }
  | { type: 'checkbox'; checkbox: boolean }
  | { type: 'url'; url: string | null }
  | { type: 'email'; email: string | null }
  | { type: 'phone_number'; phone_number: string | null };

// 📋 検証結果
interface ValidationResult {
  valid: boolean;
  errors: string[];
}

// 📋 インポート結果
interface ImportResult {
  success: boolean;
  result?: NotionPageResponse;
  error?: Error;
}

// 📋 処理ステータス
interface ProcessingStatus {
  isProcessing: boolean;
  lastProcessTime: number;
  errorHistory: Array<{
    timestamp: Date;
    error: string;
    context?: any;
  }>;
}
```

### カスタムエラークラス体系

```typescript
// 📋 基底エラークラス
export class SpreadsheetToNotionError extends Error {
  constructor(
    message: string,
    public readonly type: ErrorType,
    public readonly originalError?: Error
  ) { super(message); }
}

// 📋 具体的なエラークラス
export class ConfigError extends SpreadsheetToNotionError { ... }
export class ValidationError extends SpreadsheetToNotionError { ... }
export class MappingError extends Error { ... }
export class ApiError extends SpreadsheetToNotionError { ... }

// 📋 エラータイプ列挙
export enum ErrorType {
  CONFIG_ERROR = 'CONFIG_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  API_ERROR = 'API_ERROR',
  NETWORK_ERROR = 'NETWORK_ERROR',
  PERMISSION_ERROR = 'PERMISSION_ERROR',
}
```

## 開発・テスト戦略

### 🧪 テストスイート構成

#### **単体テスト** (`test/unit/`)
各モジュールは独立してテスト可能な設計：

```
test/unit/
├── TriggerManager.test.ts    ← シングルトン・状態管理テスト
├── ConfigManager.test.ts     ← 設定読み込み・キャッシュテスト
├── DataMapper.test.ts        ← データ変換・型安全性テスト
├── NotionApiClient.test.ts   ← API通信・レート制限テスト
├── Validator.test.ts         ← 検証ロジック・エラー分類テスト
├── Logger.test.ts            ← ログ・マスキング・タイマーテスト
└── Constants.test.ts         ← 定数・設定値テスト
```

**モック化対象の依存関係:**
- `SpreadsheetApp` (Google Apps Script API)
- `UrlFetchApp` (HTTP通信)
- `PropertiesService` (設定保存)
- `ScriptApp` (トリガー管理)
- `Session` (ユーザー情報)

#### **統合テスト** (`test/integration/`)
実際のGAS環境での動作確認：

```
test/integration/
├── basic-integration.test.ts      ← 基本機能統合テスト
├── end-to-end-basic.test.ts       ← E2Eワークフローテスト
├── notion-api-basic.test.ts       ← Notion API統合テスト
└── spreadsheet-basic.test.ts      ← スプレッドシート統合テスト
```

**現在のテスト状況**: 
- ✅ **178テスト全合格** (実行時間: ~10.6秒)
- ✅ **Jest 30.0.5** + **TypeScript** による型安全なテスト
- ✅ **継続的テスト**: `npm run test`

### 🔍 デバッグ支援機能

#### **豊富な診断関数** (`index.ts`)
手動実行可能なデバッグ機能：

```typescript
// 🔧 システム診断
globalThis.runDiagnostics              // 総合診断
globalThis.testConfiguration           // 設定診断
globalThis.diagnoseProperties          // プロパティ診断
globalThis.diagnoseColumnMappingSheet  // マッピングシート診断

// 🎛️ トリガー管理
globalThis.setupTriggers               // インストール可能トリガー設定
globalThis.clearTriggers               // トリガークリア
globalThis.showTriggerStatus           // トリガー状況表示

// 🧪 手動テスト
globalThis.testOnEditManually          // onEdit処理テスト
globalThis.testTriggerManager          // TriggerManager動作テスト
globalThis.testConnectionManually      // API接続テスト
```

#### **高機能ログシステム**
開発・運用支援のログ機能：

```typescript
// パフォーマンス計測
Logger.startTimer('操作名');
// ... 処理
Logger.endTimer('操作名');

// 機密情報マスキング
Logger.info('API Token設定', { 
  token: 'secret_abcd1234...' // → 'secret_a***' に自動マスキング
});

// 構造化ログ
Logger.error('処理エラー', {
  error: error,
  context: { rowNumber: 2, userId: 'user@example.com' }
});
```

### ⚡ パフォーマンス最適化

#### **設定キャッシュ戦略**
```typescript
export class ConfigManager {
  private static configCache: SystemConfig | null = null;
  private static cacheTimestamp = 0;
  private static readonly CACHE_DURATION = 5 * 60 * 1000; // 5分キャッシュ
  
  // キャッシュヒット率向上による高速化
}
```

#### **レート制限対応**
```typescript
class RateLimiter {
  private readonly minInterval = 334; // 3req/s制限対応
  
  async waitForRateLimit(): Promise<void> {
    // Notion API制限に準拠した効率的な通信制御
  }
}
```

### 🔒 型安全性保証

#### **TypeScript厳密設定**
```json
{
  "compilerOptions": {
    "strict": true,                           // 厳密型チェック
    "noImplicitAny": true,                   // any型禁止
    "strictNullChecks": true,                // null/undefined厳密チェック
    "noUnusedLocals": true,                  // 未使用変数検出
    "noUnusedParameters": true               // 未使用パラメータ検出
  }
}
```

#### **型ガード実装**
```typescript
export class Validator {
  // 実行時型チェックによる安全性確保
  static isValidColumnMapping(obj: any): obj is ColumnMapping {
    return typeof obj === 'object' &&
           typeof obj.spreadsheetColumn === 'string' &&
           typeof obj.notionPropertyName === 'string' &&
           // ... 詳細な型チェック
  }
}
```

## 実装ガイドライン

### 📋 **コーディング規約**

#### **命名規則**
- **クラス名**: PascalCase (`TriggerManager`, `ConfigManager`)
- **メソッド名**: camelCase (`getConfig`, `processImport`)
- **定数**: UPPER_SNAKE_CASE (`CONSTANTS.SHEETS.IMPORT_DATA`)
- **型名**: PascalCase (`SystemConfig`, `ColumnMapping`)

#### **エラーハンドリング**
```typescript
// ✅ 推奨: 具体的なエラークラス使用
throw new ConfigError('Database ID not found', originalError);

// ❌ 非推奨: 汎用Error使用
throw new Error('Something went wrong');
```

#### **ログ出力**
```typescript
// ✅ 推奨: 構造化ログ
Logger.info('処理開始', { rowNumber, userId });

// ❌ 非推奨: 単純な文字列
console.log('処理開始: 行' + rowNumber);
```

### 🚀 **デプロイメント戦略**

#### **環境別設定**
```bash
# 開発環境デプロイ
npm run deploy          # .clasp-dev.json使用

# 本番環境デプロイ  
npm run deploy:prod     # .clasp-prod.json使用
```

#### **品質保証プロセス**
```bash
# 完全な品質チェック
npm run lint           # コード品質チェック
npm run test           # 全テスト実行
npm run build          # TypeScriptコンパイル・バンドル
```

各モジュールの詳細な実装仕様は、リンクされた個別設計書を参照してください。
