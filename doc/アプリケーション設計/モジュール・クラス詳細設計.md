# モジュール・クラス詳細設計

本システムは以下のモジュールで構成されています。各モジュールの詳細設計は個別ファイルに記載しています。

## モジュール構成

### 1. [TriggerManager](./詳細設計/TriggerManager詳細設計.md)
- **役割**: スプレッドシートのトリガーイベント処理とメイン制御フロー管理
- **主要機能**: 
  - onEdit トリガー処理
  - データインポート制御
  - セキュリティチェック

### 2. [ConfigManager](./詳細設計/ConfigManager詳細設計.md)
- **役割**: システム設定情報の取得・管理
- **主要機能**:
  - スプレッドシート設定読み込み
  - API認証情報管理
  - カラムマッピング設定

### 3. [DataMapper](./詳細設計/DataMapper詳細設計.md)
- **役割**: スプレッドシートデータのNotion API形式変換
- **主要機能**:
  - データ型変換
  - プロパティマッピング
  - フォーマット調整

### 4. [NotionApiClient](./詳細設計/NotionApiClient詳細設計.md)
- **役割**: Notion APIとの通信処理
- **主要機能**:
  - ページ作成・更新
  - レート制限対応
  - API エラーハンドリング

### 5. [Validator](./詳細設計/Validator詳細設計.md)
- **役割**: データ検証処理
- **主要機能**:
  - 形式チェック
  - 必須項目チェック
  - Notionプロパティ互換性チェック

### 6. [ErrorManager](./詳細設計/ErrorManager詳細設計.md)
- **役割**: エラー分類・ログ記録・ユーザー通知
- **主要機能**:
  - エラー分類と処理
  - ユーザーフレンドリーな通知
  - ログ管理

## アーキテクチャ関係図

```
┌─────────────────┐
│  TriggerManager │ ← エントリーポイント・制御フロー
└─────────────────┘
         │
         ├─→ ┌─────────────────┐
         │   │  ConfigManager  │ ← 設定・認証管理
         │   └─────────────────┘
         │
         ├─→ ┌─────────────────┐
         │   │   DataMapper    │ ← データ変換
         │   └─────────────────┘
         │
         ├─→ ┌─────────────────┐
         │   │    Validator    │ ← データ検証
         │   └─────────────────┘
         │
         ├─→ ┌─────────────────┐
         │   │ NotionApiClient │ ← API通信
         │   └─────────────────┘
         │
         └─→ ┌─────────────────┐
             │  ErrorManager   │ ← エラー処理（全モジュールから利用）
             └─────────────────┘
```

## 共通データ構造

### システム全体で使用される共通インターフェース

```typescript
// システム設定
interface SystemConfig {
  databaseId: string;
  projectName: string;
  version: string;
  apiToken: string;
}

// カラムマッピング
interface ColumnMapping {
  spreadsheetColumn: string;
  notionPropertyName: string;
  dataType: string;
  isTarget: boolean;
  isRequired: boolean;
}

// Notionページデータ
interface NotionPageData {
  properties: Record<string, NotionProperty>;
}

// 検証結果
interface ValidationResult {
  valid: boolean;
  errors: string[];
}

// エラー処理結果
interface ErrorHandlingResult {
  handled: boolean;
  errorType?: string;
  canRetry?: boolean;
  retryDelay?: number;
}
```

## 開発・テスト指針

### 単体テスト
各モジュールは独立してテスト可能な設計としています。モック化すべき依存関係：
- SpreadsheetApp (Google Apps Script API)
- UrlFetchApp (HTTP通信)
- PropertiesService (設定保存)

### 統合テスト
実際のGoogle Apps Script環境での動作確認項目：
- スプレッドシートとの連携
- Notion APIとの通信
- エラーハンドリングの動作

### デバッグ支援
各モジュールにログ出力機能を組み込み、問題の特定を容易にしています。

## 実装の進め方

1. **フェーズ1**: 基本機能の実装
   - ConfigManager → DataMapper → Validator → NotionApiClient → ErrorManager → TriggerManager の順

2. **フェーズ2**: 拡張機能の追加
   - データ更新機能
   - バッチ処理機能

各モジュールの詳細な実装仕様は、リンクされた個別設計書を参照してください。
