# 要件定義書

## 1. 業務要件

### 1.1. システム化の目的

スプレッドシートとNotionでのタスク管理分散の解決と、外部データ取得からNotion連携までの自動化を実現する。具体的には以下の課題を解決する：

- 外部データの手動転記作業の効率化
- データ管理の一元化（Notionへの統合）
- スプレッドシートの関数機能を活用した外部データ加工とNotionでの管理の両立

### 1.2. システム化の対象範囲

**対象業務：**
- Googleスプレッドシートで取得・加工されたデータのNotionデータベースへの連携
- チェックボックス操作による手動インポート実行
- エラーハンドリングとユーザーへの通知

**対象外：**
- 外部データの取得・加工処理（既存のスプレッドシート機能で実現）
- Notionから逆方向のデータ取得
- 自動的な定期実行（手動実行のみ）

### 1.3. システム化の成功要因

以下の条件を満たした場合にシステム導入が成功したと判断する：

- チェックボックス操作でのスムーズなデータ連携が実現できる
- 外部データの加工からNotionへの登録まで30分以内で完了する
- エラー発生時に適切な情報がユーザーに提供される
- テンプレートを使用して異なるプロジェクトでも容易に再利用できる

### 1.4. ステークホルダー

- **システム開発者：** 要求定義、設計、開発、テストの実施
- **システム利用者：** 開発者本人（データ連携作業の実行）
- **データ管理者：** 開発者本人（Notion側のデータベース設計・管理）

### 1.5. 要求の優先度

**高優先度（必須機能）：**
- データインポート機能
- チェックボックストリガー
- エラーハンドリング
- カラムマッピング設定

**中優先度（推奨機能）：**
- テンプレート機能
- 設定管理機能

**低優先度（将来拡張）：**
- データ更新機能

### 1.6. 前提条件

- Googleアカウントとスプレッドシートの利用が可能であること
- Notion Integrationの作成とAPI利用が可能であること
- インターネット接続が安定していること
- clasp等のGAS開発環境が利用可能であること

### 1.7. 業務の定義

**現状の業務フロー（As-Is）：**
1. 外部サイトからのデータ取得（IMPORTHTML関数等）
2. スプレッドシートでのデータ加工（QUERY関数等）
3. 手動でのNotionへのデータ転記

**新システム導入後の業務フロー（To-Be）：**
1. 外部サイトからのデータ取得（IMPORTHTML関数等）※変更なし
2. スプレッドシートでのデータ加工（QUERY関数等）※変更なし
3. チェックボックスクリックによる自動Notion連携（新システム）

### 1.8. 業務フロー

```
[外部データソース] 
    ↓ IMPORTHTML関数
[Googleスプレッドシート]
    ↓ QUERY関数等による加工
[加工済みデータテーブル]
    ↓ チェックボックスクリック（手動操作）
[本システム（GAS）]
    ↓ Notion API呼び出し
[Notionデータベース]
```

## 2. 機能要件(FU)

### 2.1. システム提供機能(FU-SYS)

**FU-SYS-001: データインポート機能**
- 概要：スプレッドシートの行データをNotionデータベースに新規登録する
- 入力情報：スプレッドシートの行データ（3列目以降）、カラムマッピング設定
- 処理内容：データ型変換、Notion APIでのページ作成
- 出力情報：Notionページの作成、結果通知（成功/失敗）

**FU-SYS-002: チェックボックストリガー機能**
- 概要：1列目のチェックボックスがクリックされた際にインポート処理を実行
- 入力情報：チェックボックスの状態変更イベント
- 処理内容：対象行の特定、データインポート機能の呼び出し
- 出力情報：処理状況の2列目への記録

**FU-SYS-003: カラムマッピング機能**
- 概要：スプレッドシートのカラムとNotionプロパティの対応関係を管理
- 入力情報：import_columnシートの設定データ
- 処理内容：マッピング情報の読み込み、データ変換ルールの適用
- 出力情報：変換済みデータ（Notion API形式）

**FU-SYS-004: エラーハンドリング機能**
- 概要：処理失敗時の適切なエラー通知とログ記録
- 入力情報：API実行結果、例外情報
- 処理内容：エラー分類、メッセージ生成
- 出力情報：ポップアップ通知、エラーログ

**FU-SYS-005: 設定管理機能**
- 概要：Notion API認証情報とデータベース設定の管理
- 入力情報：設定シートのデータ、GASプロパティの値
- 処理内容：設定値の読み込み・検証
- 出力情報：設定済み認証情報、DB接続情報

**FU-SYS-006: NotionDB情報取得機能**
- 概要：Notionデータベースのプロパティ情報を取得してマッピング設定を支援
- 入力情報：データベースID
- 処理内容：Notion API でのデータベース情報取得
- 出力情報：プロパティ一覧（名前、タイプ）

**FU-SYS-007: データ更新機能（フェーズ2）**
- 概要：2列目の主キー情報を使用して既存Notionページを更新
- 入力情報：スプレッドシートの行データ、主キー情報
- 処理内容：既存ページの検索、データ更新
- 出力情報：更新結果の通知

### 2.2. UI/UX要件(FU-UIUX)

**FU-UIUX-001: ユーザー体験要件**
- 直感的な操作：チェックボックスクリック→自動処理実行
- 即座のフィードバック：処理結果のポップアップ表示
- エラー時の明確な説明：具体的なエラー内容と対処方法の提示

**FU-UIUX-002: スプレッドシート構成**
- 1列目：チェックボックス（インポートトリガー）
- 2列目：主キー情報（Notion Page ID等）
- 3列目以降：実データ（Notionに連携するデータ）

**FU-UIUX-003: シート構成**
- import_data：メインデータシート
- import_column：カラムマッピング設定シート
- config：システム設定シート（Notion DB ID等）

### 2.3. データ要件(FU-DATA)

**FU-DATA-001: 概念データモデル**

*スプレッドシートデータ構造：*
```
| チェックボックス | 主キー | データ1 | データ2 | ... |
|       □        | null  | 値1    | 値2    | ... |
```

*カラムマッピング構造：*
```
| スプレッドシートカラム | Notionプロパティ名 | データ型 | 連携対象 |
| データ1             | Name            | Title   | Yes     |
| データ2             | Age             | Number  | Yes     |
```

*設定シート構造：*
```
| 項目名        | 値                    |
| DATABASE_ID  | notion_database_id    |
| PROJECT_NAME | プロジェクト名          |
```

**FU-DATA-002: 対応データ型**
- Notion Title → スプレッドシート文字列
- Notion Text → スプレッドシート文字列  
- Notion Number → スプレッドシート数値
- Notion Date → スプレッドシート日付
- Notion Select → スプレッドシート文字列（選択肢と一致）
- Notion Multi-select → スプレッドシート文字列（カンマ区切り）
- Notion Checkbox → スプレッドシートBoolean
- Notion URL → スプレッドシートURL形式文字列

**FU-DATA-003: データ容量想定**
- 1回の処理件数：1〜100件程度
- 月間処理回数：10〜50回程度
- 年間データ蓄積量：1,000〜5,000件程度

## 3. 非機能要件(NFU)

### 3.1. 可用性要件(NFU-AVA)

**NFU-AVA-001: 稼働時間**
- 24時間365日（Google Apps Scriptの稼働時間に依存）
- メンテナンス時間：Google側のメンテナンス時のみ

**NFU-AVA-002: 年間運用スケジュール**
- 定期メンテナンス：不要
- アップデート：機能追加時のみ

**NFU-AVA-003: 目標復旧時間（RTO）**
- システム障害時：24時間以内（個人利用のため）

**NFU-AVA-004: 目標復旧時点（RPO）**
- データ損失許容時間：24時間（手動実行のため再実行可能）

**NFU-AVA-005: 信頼性**
- API接続成功率：95%以上
- データ転送成功率：98%以上

**NFU-AVA-006: 災害・障害対策**
- Google Apps Script基盤の冗長性に依存
- スプレッドシートのバックアップ：Google Driveの機能を利用

### 3.2. 性能要件(NFU-PER)

**NFU-PER-001: 応答時間**
- チェックボックスクリック→処理完了：5秒以内
- エラー通知表示：即座（1秒以内）
- 設定読み込み：2秒以内

**NFU-PER-002: スループット**
- 同時処理：不要（手動実行）
- 1件あたりの処理時間：3秒以内
- API Rate Limit対応：Notion APIの制限に準拠

**NFU-PER-003: リソース使用量**
- GAS実行時間制限：6分以内（Googleの制限）
- メモリ使用量：制限内での効率的な処理

### 3.3. 拡張性（スケーラビリティ）要件(NFU-SCA)

**NFU-SCA-001: 利用者数拡張**
- 現在：1名（開発者本人）
- 将来：テンプレート公開により不特定多数での利用可能

**NFU-SCA-002: データ量拡張**
- 現在：月間100件程度
- 将来：月間1,000件程度まで対応可能

**NFU-SCA-003: 機能拡張**
- 新しいNotionプロパティタイプへの対応
- 複数データベースへの同時連携
- バッチ処理機能の追加

### 3.4. 運用・保守要件(NFU-OPS)

**NFU-OPS-001: 業務運用要件**
- 運用者：開発者本人
- 運用時間：必要時のみ
- 監視：手動での状況確認

**NFU-OPS-002: システム運用要件**
- ログ管理：エラーログの保持（GASログ機能を利用）
- バックアップ：不要（データソースはスプレッドシート）
- 性能監視：手動での確認

**NFU-OPS-003: 保守性**
- コード管理：Git（GitHub）での管理
- ドキュメント：README.mdでの運用手順記載
- アップデート：clasp pushでの反映

### 3.5 移行性要件(NFU-MIG)

**NFU-MIG-001: 移行方針**
- 新規構築（既存システムからの移行は不要）
- テンプレートベースでの展開

**NFU-MIG-002: 移行対象データ**
- 移行対象：なし
- 新規データのみ取り扱い

**NFU-MIG-003: 導入手順**
1. テンプレートスプレッドシートのコピー
2. Notion Integrationの作成
3. GASプロパティでのAPI Token設定
4. 設定シートでのDB ID設定
5. カラムマッピングの設定
6. テストデータでの動作確認

**NFU-MIG-004: 利用者トレーニング**
- 対象：開発者本人のため不要
- 一般公開時：README.mdでの利用手順提供

### 3.6. セキュリティ要件(NFU-SEC)

**NFU-SEC-001: アクセス制御**
- スプレッドシート：作成者のみアクセス可能
- Notion Integration：最小権限での設定
- GAS：作成者のみ編集可能

**NFU-SEC-002: データ秘匿性**
- API Token：GASプロパティサービスでの暗号化保存
- 機密データ：スプレッドシート内での管理（個人利用想定）

**NFU-SEC-003: 通信セキュリティ**
- HTTPS通信：Notion APIとの通信
- 認証：Bearer Token方式

**NFU-SEC-004: ログ・監査**
- アクセスログ：GASの実行ログを利用
- エラーログ：処理失敗時の記録
- 操作ログ：スプレッドシートの編集履歴

## 4. システム基盤

**システム構成図：**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Googleスプレッド  │    │ Google Apps     │    │ Notion Database │
│ シート           │◄──►│ Script (GAS)    │◄──►│                │
│                 │    │                 │    │                 │
│ ・import_data   │    │ ・データ変換     │    │ ・ページ作成     │
│ ・import_column │    │ ・API呼び出し    │    │ ・プロパティ管理 │
│ ・config        │    │ ・エラー処理     │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

**ハードウェア構成：**
- サーバー：Google Apps Script クラウド基盤
- クライアント：Webブラウザ（Google Chrome推奨）
- ストレージ：Google Drive（スプレッドシート保存）

**ソフトウェア構成：**
- 実行環境：Google Apps Script V8 Runtime
- 開発環境：clasp + Visual Studio Code
- API：Notion API v1
- 認証：OAuth 2.0 (Notion Integration Token)

**ネットワーク構成：**
- インターネット接続必須
- HTTPS通信（Google ↔ Notion）
- APIレート制限：Notion API制限に準拠

## 5. プロジェクト管理要件

**開発スケジュール：**
- フェーズ1（基本機能）：4週間
  - 週1：環境構築・基本設計
  - 週2：データインポート機能開発
  - 週3：UI実装・エラーハンドリング
  - 週4：テスト・ドキュメント作成

- フェーズ2（拡張機能）：2週間
  - 週1：データ更新機能開発
  - 週2：テスト・リファクタリング

**開発リソース：**
- 開発者：1名（要求者本人）
- 作業時間：週10時間程度

**開発環境：**
- ローカル開発：Visual Studio Code + clasp
- テスト環境：Google Apps Script Editor
- バージョン管理：Git (GitHub)

**開発ドキュメント：**
- 要求定義書
- 要件定義書  
- システム設計書
- モジュール詳細設計書
- README.md（利用手順）
- API仕様書

**技術的リスク・課題と対策：**

| リスク項目 | 影響度 | 対策 |
|-----------|--------|------|
| Notion APIの制限変更 | 高 | 定期的なAPI仕様確認、エラーハンドリングの充実 |
| GAS実行時間制限 | 中 | 処理の分割、効率的なアルゴリズム採用 |
| データ型変換エラー | 中 | 詳細なバリデーション、エラーメッセージの充実 |
| テンプレート配布の複雑さ | 低 | シンプルな設定手順、詳細なドキュメント作成 |

## 6. 用語集

|用語|説明|
|---|---|
|GAS|Google Apps Scriptの略称。Googleのクラウドベースの開発プラットフォーム|
|clasp|Command Line Apps Script Projectsの略称。GASをローカル開発するためのツール|
|Notion Integration|NotionがサードパーティーアプリケーションにAPIアクセスを許可する仕組み|
|Database ID|Notionデータベースを一意に識別するID文字列|
|Page ID|Notionページを一意に識別するID文字列|
|プロパティタイプ|Notionデータベースのカラムの種類（Title、Text、Number等）|
|Rate Limit|API呼び出し頻度の制限|
|Bearer Token|HTTP認証方式の一種。Notion APIで使用される認証トークン|
|IMPORTHTML|GoogleスプレッドシートでWebページのテーブルデータを取得する関数|
|QUERY|Googleスプレッドシートでデータのフィルタリング・集計を行う関数|
